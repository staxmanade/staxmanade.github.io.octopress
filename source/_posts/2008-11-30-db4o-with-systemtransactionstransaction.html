---
layout: post
title: "Db4o with System.Transactions.TransactionScope"
date: 2008-11-30T14:15:00-08:00
comments: false
alias: /blog/8119831855686549005
---

<div class='post'>
<p>After after reading Rob Conery's post <a href="http://blog.wekeroad.com/blog/crazy-talk-reducing-orm-friction/">http://blog.wekeroad.com/blog/crazy-talk-reducing-orm-friction/</a>. I thought I'd give it a whirl and didn't get very far before I ran into my first roadblock. DB4O version 7.4.68 doesn't support any .NET System.Transaction. (For what I could tell...)</p>  <p>Below I'll explain how I pieced this together and made it work (At least an alpha type version to work...)</p>  <p>Assume I've followed almost everything Rob has in his blog for setup (IRepository, DB4O container class, ObjectRepository&lt;T&gt;, etc...)</p>  <p>My first unit test was the following </p>  <p>[Test]   <br /><span style="color: #0000ff">public</span> <span style="color: #0000ff">void</span> CanRollbackSavedObjectInRepository()    <br />{    <br />&#160; <span style="color: #0000ff">using</span> (TransactionScope scope = <span style="color: #0000ff">new</span> TransactionScope())    <br />&#160; {    <br />&#160;&#160;&#160; _repository.Save(_dummyObject);    <br />&#160;&#160;&#160; <span style="color: #008000">//NO: scope.Complete(); Implied rollback</span>    <br />&#160; }    <br />    <br />&#160; <span style="color: #0000ff">if</span> (_repository.GetAll().Count() &gt; 0)    <br />&#160;&#160;&#160; Assert.Fail(&quot;<span style="color: #8b0000">TransactionScope Failed - count[</span>&quot; + _repository.GetAll().Count().ToString() + &quot;<span style="color: #8b0000">]</span>&quot;);    <br />}    <br /></p>  <p>And the above test fails...</p>  <p>Next was some research to figure out why this was failing... I didn't find much out there, except for some pending TODO's on the DB4O project.</p>  <p><a href="http://tracker.db4o.com/browse/COR-1376">http://tracker.db4o.com/browse/COR-1376</a>    <br /><a href="http://tracker.db4o.com/browse/COR-1143">http://tracker.db4o.com/browse/COR-1143</a></p>  <p>&#160;</p>  <p>So then it was off to figure out how frameworks implemented there resource managers to hook into the System.Transaction goo...</p>  <p>(Long story short, and several trial and error failures) The best of the solutions I found was in this open source code base. (<a href="http://code.google.com/p/uniframework/">http://code.google.com/p/uniframework/</a>)</p>  <p>In that project there was a class that managed the enlistment of a transaction, and some examples of how to use it...</p>  <p><a href="http://code.google.com/p/uniframework/source/browse/trunk/sources/Uniframework/Db4o/Db4oEnlist.cs">http://code.google.com/p/uniframework/source/browse/trunk/sources/Uniframework/Db4o/Db4oEnlist.cs</a> is the enlistment class.</p>  <p>&#160;</p>  <p>I placed this Db4oEnlist class as a private nested class inside the ObjectRepository&lt;T&gt; since I can't see why it would be used anywhere else...</p>  <p>And below is how I use them in the ObjectRepository&lt;T&gt;.</p>  <pre><span style="color: #0000ff">public</span> <span style="color: #0000ff">void</span> Delete(T item)<br />{<br />  Db4oEnlist enlist = <span style="color: #0000ff">new</span> Db4oEnlist(Container, item);<br />  <span style="color: #0000ff">bool</span> inTransaction = Enlist(enlist);<br />  Container.Delete(item);<br />  <span style="color: #0000ff">if</span> (!inTransaction)<br />    Container.Commit();<br />}</pre><br /><br /><pre><span style="color: #0000ff">public</span> <span style="color: #0000ff">void</span> Save(T item)<br />{<br />  Db4oEnlist enlist = <span style="color: #0000ff">new</span> Db4oEnlist(Container, item);<br />  <span style="color: #0000ff">bool</span> inTransaction = Enlist(enlist);<br />  Container.Store(item);<br />  <span style="color: #0000ff">if</span> (!inTransaction)<br />    Container.Commit();<br />}</pre><br /><br /><p>&#160;</p><br /><br /><p>We first create an instance of the Db4OEnlist class with the current container. This class implements the IEnlistmentNotification interface and knows how to commit/rollback/etc on the object database. We then use the private helper method Enlist() giving it the Db4OEnlist instance. This helper method enlists the sequence in any existing transactions returning if it enlisted in a transaction or not.</p><br /><br /><pre><span style="color: #0000ff">private</span> <span style="color: #0000ff">static</span> <span style="color: #0000ff">bool</span> Enlist(Db4oEnlist enlist)<br />{<br />  System.Transactions.Transaction currentTx = System.Transactions.Transaction.Current;<br />  <span style="color: #0000ff">if</span> (currentTx != <span style="color: #0000ff">null</span>)<br />  {<br />    currentTx.EnlistVolatile(enlist, EnlistmentOptions.None);<br />    <span style="color: #0000ff">return</span> <span style="color: #0000ff">true</span>;<br />  }<br />  <span style="color: #0000ff">return</span> <span style="color: #0000ff">false</span>;<br />}</pre><br /><br /><p>If we aren't in a transaction we commit the action right away, however if we are in the transaction we let the .net System.Transaction framework take care of committing the transaction.</p><br /><br /><p>Once I found the example in the &quot;uniframework&quot; it came together rather quickly...</p><br /><br /><p>Below is the ObjectRepository&lt;T&gt; I'm going forward with on testing Rob's idea of developing an application using the object database first... (we'll see how it goes)</p><br /><br /><pre><span style="color: #0000ff">public</span> <span style="color: #0000ff">class</span> ObjectRepository&lt;T&gt; :<br />  IRepository&lt;T&gt; where T : <span style="color: #0000ff">class</span><br />{<br />  <span style="color: #808080">/// &lt;summary&gt;</span><br />  <span style="color: #808080">/// Returns all T records in the repository</span><br />  <span style="color: #808080">/// &lt;/summary&gt;</span><br />  <span style="color: #0000ff">public</span> IQueryable&lt;T&gt; GetAll()<br />  {<br />    <span style="color: #0000ff">return</span> (from T items <span style="color: #0000ff">in</span> Container<br />        select items).AsQueryable();<br />  }<br /><br />  <span style="color: #808080">/// &lt;summary&gt;</span><br />  <span style="color: #808080">/// Finds an item using a passed-in expression lambda</span><br />  <span style="color: #808080">/// &lt;/summary&gt;</span><br />  <span style="color: #0000ff">public</span> IQueryable&lt;T&gt; Find(System.Linq.Expressions.Expression&lt;Func&lt;T, <span style="color: #0000ff">bool</span>&gt;&gt; expression)<br />  {<br />    <span style="color: #0000ff">return</span> GetAll().Where(expression);<br />  }<br /><br />  <span style="color: #808080">/// &lt;summary&gt;</span><br />  <span style="color: #808080">/// Saves an item to the database</span><br />  <span style="color: #808080">/// &lt;/summary&gt;</span><br />  <span style="color: #808080">/// &lt;param name=&quot;item&quot;&gt;&lt;/param&gt;</span><br />  <span style="color: #0000ff">public</span> <span style="color: #0000ff">void</span> Save(T item)<br />  {<br />    Db4oEnlist enlist = <span style="color: #0000ff">new</span> Db4oEnlist(Container, item);<br />    <span style="color: #0000ff">bool</span> inTransaction = Enlist(enlist);<br />    Container.Store(item);<br />    <span style="color: #0000ff">if</span> (!inTransaction)<br />      Container.Commit();<br />  }<br /><br />  <span style="color: #808080">/// &lt;summary&gt;</span><br />  <span style="color: #808080">/// Deletes an item from the database</span><br />  <span style="color: #808080">/// &lt;/summary&gt;</span><br />  <span style="color: #808080">/// &lt;param name=&quot;item&quot;&gt;&lt;/param&gt;</span><br />  <span style="color: #0000ff">public</span> <span style="color: #0000ff">void</span> Delete(T item)<br />  {<br />    Db4oEnlist enlist = <span style="color: #0000ff">new</span> Db4oEnlist(Container, item);<br />    <span style="color: #0000ff">bool</span> inTransaction = Enlist(enlist);<br />    Container.Delete(item);<br />    <span style="color: #0000ff">if</span> (!inTransaction)<br />      Container.Commit();<br />  }<br /><br />  <span style="color: #0000ff">private</span> <span style="color: #0000ff">static</span> <span style="color: #0000ff">bool</span> Enlist(Db4oEnlist enlist)<br />  {<br />    System.Transactions.Transaction currentTx = System.Transactions.Transaction.Current;<br />    <span style="color: #0000ff">if</span> (currentTx != <span style="color: #0000ff">null</span>)<br />    {<br />      currentTx.EnlistVolatile(enlist, EnlistmentOptions.None);<br />      <span style="color: #0000ff">return</span> <span style="color: #0000ff">true</span>;<br />    }<br />    <span style="color: #0000ff">return</span> <span style="color: #0000ff">false</span>;<br />  }<br /><br />  <span style="color: #0000ff">private</span> <span style="color: #0000ff">static</span> IObjectContainer Container<br />  {<br />    <span style="color: #0000ff">get</span><br />    {<br />      <span style="color: #0000ff">return</span> ServiceLocator.Current.GetInstance&lt;IObjectContainer&gt;();<br />    }<br />  }<br /><br />  <span style="color: #808080">/// &lt;summary&gt;</span><br />  <span style="color: #808080">/// Provides support for System.Transaction integration</span><br />  <span style="color: #808080">/// &lt;/summary&gt;</span><br />  <span style="color: #0000ff">private</span> <span style="color: #0000ff">class</span> Db4oEnlist : IEnlistmentNotification<br />  {<br />    <span style="color: #0000ff">private</span> IObjectContainer container;<br />    <span style="color: #0000ff">private</span> <span style="color: #0000ff">object</span> oldItem;<br /><br />    <span style="color: #808080">/// &lt;summary&gt;</span><br />    <span style="color: #808080">/// Initializes a new instance of the &lt;see cref=&quot;db4oEnlist&quot;/&gt; class.</span><br />    <span style="color: #808080">/// &lt;/summary&gt;</span><br />    <span style="color: #808080">/// &lt;param name=&quot;database&quot;&gt;The database.&lt;/param&gt;</span><br />    <span style="color: #808080">/// &lt;param name=&quot;item&quot;&gt;The item.&lt;/param&gt;</span><br />    <span style="color: #0000ff">public</span> Db4oEnlist(IObjectContainer container, <span style="color: #0000ff">object</span> item)<br />    {<br />      <span style="color: #0000ff">this</span>.container = container;<br />      oldItem = item;<br />    }<br /><br />    #region IEnlistmentNotification<br /><br />    <span style="color: #808080">/// &lt;summary&gt;</span><br />    <span style="color: #808080">/// Commits the specified enlistment.</span><br />    <span style="color: #808080">/// &lt;/summary&gt;</span><br />    <span style="color: #808080">/// &lt;param name=&quot;enlistment&quot;&gt;The enlistment.&lt;/param&gt;</span><br />    <span style="color: #0000ff">public</span> <span style="color: #0000ff">void</span> Commit(Enlistment enlistment)<br />    {<br />      container.Commit();<br />      oldItem = <span style="color: #0000ff">null</span>;<br />    }<br /><br />    <span style="color: #808080">/// &lt;summary&gt;</span><br />    <span style="color: #808080">/// Ins the doubt.</span><br />    <span style="color: #808080">/// &lt;/summary&gt;</span><br />    <span style="color: #808080">/// &lt;param name=&quot;enlistment&quot;&gt;The enlistment.&lt;/param&gt;</span><br />    <span style="color: #0000ff">public</span> <span style="color: #0000ff">void</span> InDoubt(Enlistment enlistment)<br />    {<br />      <span style="color: #008000">//throw new Exception(&quot;The method or operation is not implemented.&quot;);</span><br />    }<br /><br />    <span style="color: #808080">/// &lt;summary&gt;</span><br />    <span style="color: #808080">/// Prepares the specified preparing enlistment.</span><br />    <span style="color: #808080">/// &lt;/summary&gt;</span><br />    <span style="color: #808080">/// &lt;param name=&quot;preparingEnlistment&quot;&gt;The preparing enlistment.&lt;/param&gt;</span><br />    <span style="color: #0000ff">public</span> <span style="color: #0000ff">void</span> Prepare(PreparingEnlistment preparingEnlistment)<br />    {<br />      preparingEnlistment.Prepared();<br />    }<br /><br />    <span style="color: #808080">/// &lt;summary&gt;</span><br />    <span style="color: #808080">/// Rollbacks the specified enlistment.</span><br />    <span style="color: #808080">/// &lt;/summary&gt;</span><br />    <span style="color: #808080">/// &lt;param name=&quot;enlistment&quot;&gt;The enlistment.&lt;/param&gt;</span><br />    <span style="color: #0000ff">public</span> <span style="color: #0000ff">void</span> Rollback(Enlistment enlistment)<br />    {<br />      container.Rollback();<br />      container.Ext().Refresh(oldItem, <span style="color: #0000ff">int</span>.MaxValue);<br />    }<br /><br />    #endregion<br />  }<br />}</pre>  </div>
<h2>Comments</h2>
<div class='comments'>
<div class='comment'>
<div class='author'>Magento theme</div>
<div class='content'>
I found so many interesting stuff in your blog especially its discussion. So i must appreciate your efforts on posting these information.</div>
</div>
<div class='comment'>
<div class='author'>German Viscuso</div>
<div class='content'>
Hi!<BR/><BR/>You’ve been nominated as db4o dVP. Please see <A HREF="http://developer.db4o.com/blogs/community/archive/2009/03/04/meet-the-new-db4objects-valued-professionals-dvp-for-2009.aspx" REL="nofollow">this page</A><BR/>I don’t have your contact info!<BR/><BR/>Best!<BR/><BR/>German</div>
</div>
<div class='comment'>
<div class='author'>German Viscuso</div>
<div class='content'>
Great stuff!<BR/>See:<BR/> <BR/>http://developer.db4o.com/blogs/community/archive/2008/12/11/db4o-with-system-transactions-transactionscope.aspx<BR/><BR/>Best regards.<BR/><BR/>German Viscuso<BR/>db4objects community manager</div>
</div>
</div>
